<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TGWeb Offline</title>
  <style>
    :root {
      --bg: #0e1621;
      --card: #17212b;
      --muted: #8ca2b8;
      --text: #eaf3ff;
      --accent: #4fa8ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #0d141d, var(--bg));
      color: var(--text);
    }
    .header {
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(8px);
      background: rgba(14, 22, 33, 0.86);
      border-bottom: 1px solid rgba(120, 150, 180, 0.2);
      padding: 14px 16px;
    }
    .title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
    }
    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 8px 12px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      font-size: 13px;
    }
    .ghost {
      background: #293c52;
    }
    .stats {
      padding: 12px 16px 4px;
      color: var(--muted);
      font-size: 12px;
    }
    .list {
      padding: 0 12px 18px;
      display: grid;
      gap: 8px;
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(120, 150, 180, 0.18);
      border-radius: 12px;
      padding: 12px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .name {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.2;
    }
    .badge {
      min-width: 22px;
      text-align: center;
      padding: 2px 7px;
      border-radius: 999px;
      background: #2d74ac;
      font-size: 12px;
      font-weight: 700;
      color: #e7f5ff;
    }
    .preview {
      color: #bfd0e3;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .message {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      font-size: 13px;
      color: #d8e8fa;
      overflow-wrap: anywhere;
    }
    .footer {
      padding: 8px 16px 18px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">Offline mode</h1>
    <div class="subtitle">Showing cached dialogs/messages from local snapshot.</div>
    <div class="actions">
      <button onclick="location.href='https://web.telegram.org/k/'">Try online</button>
      <button class="ghost" onclick="location.reload()">Refresh cache view</button>
    </div>
  </div>

  <div id="stats" class="stats">Waiting for cached snapshot...</div>
  <div id="dialogs" class="list"></div>
  <div class="footer">
    This screen is driven by native snapshot cache. It updates after background sync/push.
  </div>

  <script>
    const statsEl = document.getElementById('stats');
    const listEl = document.getElementById('dialogs');

    function formatTime(ts) {
      if (!ts) return 'unknown';
      try {
        return new Date(ts).toLocaleString();
      } catch (_) {
        return String(ts);
      }
    }

    function render(snapshot) {
      const dialogs = Array.isArray(snapshot?.dialogs) ? snapshot.dialogs : [];
      const messages = Array.isArray(snapshot?.recentMessages) ? snapshot.recentMessages : [];
      const byChat = new Map();
      for (const msg of messages) {
        if (!byChat.has(msg.chatId)) byChat.set(msg.chatId, []);
        byChat.get(msg.chatId).push(msg);
      }

      statsEl.textContent =
        `Dialogs: ${dialogs.length} | Unread: ${snapshot?.unread || 0} | Cached media: ${(snapshot?.cachedMedia || []).length} | Last sync: ${formatTime(snapshot?.lastSyncAt)}`;

      listEl.innerHTML = '';
      if (!dialogs.length) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.textContent = 'No cached dialogs yet. Open app online once and wait for sync.';
        listEl.appendChild(empty);
        return;
      }

      for (const dialog of dialogs) {
        const card = document.createElement('div');
        card.className = 'card';

        const row = document.createElement('div');
        row.className = 'row';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = dialog.title || `Chat ${dialog.chatId}`;

        row.appendChild(name);
        if ((dialog.unreadCount || 0) > 0) {
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = String(dialog.unreadCount);
          row.appendChild(badge);
        }

        const preview = document.createElement('div');
        preview.className = 'preview';
        preview.textContent = dialog.lastMessagePreview || 'No preview';

        card.appendChild(row);
        card.appendChild(preview);

        const localMessages = (byChat.get(dialog.chatId) || []).slice(0, 3);
        for (const message of localMessages) {
          const block = document.createElement('div');
          block.className = 'message';
          block.textContent = message.text || '[empty]';
          card.appendChild(block);
        }

        listEl.appendChild(card);
      }
    }

    window.addEventListener('tgweb-native-bootstrap', (event) => {
      render(event.detail || {});
    });

    if (window.__TGWEB_BOOTSTRAP__) {
      render(window.__TGWEB_BOOTSTRAP__);
    }
  </script>
</body>
</html>
